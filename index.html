<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IC PUCP • TI APP</title>

  <style>
    :root{
      --ic-navy:#0B2E5E;
      --ic-navy-2:#082449;
      --ic-gold:#F0B429;
      --bg:#F4F6F9;
      --card:#FFFFFF;
      --text:#0F172A;
      --muted:#64748B;
      --line:#E5E7EB;
      --shadow: 0 10px 28px rgba(2, 6, 23, .10);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: var(--bg);
    }

    header{
      background: linear-gradient(180deg, var(--ic-navy), var(--ic-navy-2));
      color:#fff;
      border-bottom: 4px solid rgba(240,180,41,.95);
    }
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:14px}
    .brand img{height:40px;width:auto;display:block}
    .title h1{margin:0;font-size:18px;font-weight:900;letter-spacing:.2px}
    .title p{margin:2px 0 0;font-size:12.5px;opacity:.9}
    .tag{font-weight:900;letter-spacing:.8px}

    main{padding:18px 0 36px}
    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:18px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .tile{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      cursor:pointer;
      transition:.12s transform, .12s filter;
      display:flex;flex-direction:column;
      min-height: 260px;
    }
    .tile:hover{transform: translateY(-2px);filter:brightness(.99)}
    .tileTop{
      padding:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      height: 170px;
    }
    .tileTop img{max-height:140px;max-width:90%;object-fit:contain}
    .tileBottom{
      background: rgba(11,46,94,.06);
      border-top:1px solid var(--line);
      padding:14px 16px;
      font-weight:900;
      color: var(--ic-navy);
      display:flex;align-items:center;justify-content:space-between;
    }
    .chev{opacity:.55}

    /* Panels */
    .panel{
      display:none;
      margin-top:18px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel.show{display:block}
    .panelHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(11,46,94,.06), transparent);
    }
    .panelHead h2{margin:0;font-size:15px;font-weight:900}
    .panelHead p{margin:4px 0 0;color:var(--muted);font-size:12.5px;line-height:1.35}
    .panelBody{padding:16px}

    .row{display:grid;grid-template-columns: 1fr 1fr;gap:14px}
    @media (max-width: 980px){ .row{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:14px;
      background:#fff;
    }
    .card h3{margin:0 0 6px;font-size:13.5px}
    .muted{color:var(--muted);font-size:12.5px;line-height:1.35;margin:0}

    .btn, button{
      appearance:none;border:1px solid var(--line);
      background:#fff;color:var(--text);
      padding:10px 12px;border-radius:12px;
      font-weight:900;font-size:13px;cursor:pointer;
      transition:.12s transform, .12s filter;
    }
    .btn:hover, button:hover{transform: translateY(-1px);filter:brightness(.98)}
    .btn:disabled, button:disabled{opacity:.55;cursor:not-allowed;transform:none}
    .primary{
      background: var(--ic-gold);
      border-color: rgba(0,0,0,.08);
    }
    .ghost{background:transparent;color:var(--muted)}
    input[type="file"]{display:none}

    textarea{
      width:100%;
      min-height: 160px;
      border:1px solid var(--line);
      border-radius: 12px;
      padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12.5px;
      outline:none;
    }

    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px 10px;
      margin-top:10px;
      font-size:12.5px;
      align-items:center;
    }
    .kv .k{color:var(--muted)}
    .kv .v{font-weight:900}

    .toast{
      margin-top:12px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#F8FAFC;
      font-size:12.5px;
      color:var(--muted);
      display:none;
    }
    .toast.ok{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08); color:#14532D}
    .toast.warn{border-color: rgba(240,180,41,.45); background: rgba(240,180,41,.10); color:#7A4E00}
    .toast.bad{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08); color:#7F1D1D}

    .progress{
      height:10px;border-radius:999px;
      background:#E5E7EB;
      overflow:hidden;
      margin-top:10px;
      display:none;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--ic-gold), #FFD56A);
      transition: width .2s ease;
    }

    .line{height:1px;background:var(--line);margin:14px 0}

    select{
      width:100%;
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 12px;
      font-weight:800;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img src="logo-blanco-calidad.png" alt="Instituto para la Calidad PUCP" />
        <div class="title">
          <h1>TI APP</h1>
          <p>Portal de procesos TI • Instituto para la Calidad PUCP</p>
        </div>
      </div>
      <div class="tag">TI APP</div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">

    <!-- Tiles -->
    <div class="grid" id="tiles">
      <div class="tile" data-open="panel-canvas">
        <div class="tileTop">
          <img src="assets/canvas.png" alt="Canvas" onerror="this.style.display='none'">
          <div id="ph-canvas" style="display:none;font-weight:900;color:var(--ic-navy)">Canvas</div>
        </div>
        <div class="tileBottom">
          <span>Canvas</span><span class="chev">›</span>
        </div>
      </div>

      <div class="tile" data-open="panel-m365">
        <div class="tileTop">
          <img src="assets/m365.png" alt="M365" onerror="this.style.display='none'">
          <div id="ph-m365" style="display:none;font-weight:900;color:var(--ic-navy)">M365</div>
        </div>
        <div class="tileBottom">
          <span>M365</span><span class="chev">›</span>
        </div>
      </div>

      <div class="tile" data-open="panel-otros">
        <div class="tileTop">
          <img src="assets/otros.png" alt="Otros" onerror="this.style.display='none'">
          <div id="ph-otros" style="display:none;font-weight:900;color:var(--ic-navy)">Otros</div>
        </div>
        <div class="tileBottom">
          <span>Otros</span><span class="chev">›</span>
        </div>
      </div>
    </div>

    <!-- ===== Panel Canvas  ===== -->
    <section class="panel" id="panel-canvas">
      <div class="panelHead">
        <div>
          <h2>Canvas • Gestión de usuarios</h2>
          <p>Búsqueda por SIS ID • Baja / Reactivación • Matrículas activas (vía Cloudflare Worker)</p>
        </div>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <!-- Badge backend -->
          <div class="c-badge" id="badgeBackend" title="Estado del backend">
            <span class="c-dot" id="dotBackend"></span>
            <span id="txtBackend">Conectando...</span>
          </div>

          <button class="btn ghost" data-close>Volver</button>
        </div>
      </div>

      <div class="panelBody">
        <div id="canvasApp">

          <style>
            /* =========================================================
              Canvas App - SCOPE total
              (para que no choque con .card/.grid/.wrap del portal)
              ========================================================= */
            #canvasApp{
              --border:#e6e9ef;
              --muted:#64748b;
              --text:#0f172a;
              --ok:#16a34a;
              --bad:#dc2626;
              --warn:#f59e0b;
              --shadow:0 10px 30px rgba(2,6,23,.08);
              --radius:16px;

              color:var(--text);
            }

            /* Badge en el panelHead */
            #panel-canvas .c-badge{
              display:inline-flex;align-items:center;gap:8px;
              padding:10px 12px;border-radius:999px;
              border:1px solid var(--line);
              background:#fff;
              font-weight:900;
              color:var(--text);
              font-size:13px;
            }
            #panel-canvas .c-dot{
              width:10px;height:10px;border-radius:50%;
              background:var(--warn);
              box-shadow:0 0 0 4px rgba(245,158,11,.15);
            }
            #panel-canvas .c-dot.ok{background:var(--ok);box-shadow:0 0 0 4px rgba(22,163,74,.15)}
            #panel-canvas .c-dot.bad{background:var(--bad);box-shadow:0 0 0 4px rgba(220,38,38,.15)}

            /* Card principal (igual vibe a M365) */
            #canvasApp .c-card{
              background:#fff;
              border:1px solid var(--line);
              border-radius: 16px;
              box-shadow: none;
              overflow:hidden;
            }
            #canvasApp .c-card-head{
              padding:16px;
              border-bottom:1px solid var(--line);
            }
            #canvasApp .c-card-head h3{
              margin:0;
              font-size:18px;
              font-weight:1000;
              letter-spacing:.2px;
            }
            #canvasApp .c-card-head p{
              margin:6px 0 0;
              color:var(--muted);
              font-size:13.5px;
            }

            /* GRID de 2 columnas (esto es lo que te faltaba ver en la imagen) */
            #canvasApp .c-grid{
              display:grid;
              grid-template-columns: 1.1fr .9fr;
              gap:14px;
              padding:16px;
            }
            @media (max-width: 980px){
              #canvasApp .c-grid{grid-template-columns:1fr}
            }

            #canvasApp .c-panel{
              border:1px solid var(--line);
              border-radius:14px;
              padding:14px;
              background:#fff;
            }
            #canvasApp .c-panel h4{
              margin:0;
              font-size:15px;
              font-weight:1000;
            }
            #canvasApp .c-panel p{
              margin:6px 0 12px;
              color:var(--muted);
              font-size:13.5px;
              line-height:1.35;
            }

            #canvasApp .c-label{
              display:block;
              font-weight:900;
              margin:10px 0 8px;
              font-size:13px;
            }
            #canvasApp .c-input{
              width:100%;
              border:1px solid var(--line);
              border-radius:14px;
              padding:12px 14px;
              font-size:15px;
              outline:none;
              background:#fff;
            }
            #canvasApp .c-input:focus{
              border-color:#b9c4d8;
              box-shadow:0 0 0 4px rgba(15,23,42,.06);
            }

            #canvasApp .c-row{
              display:flex;
              gap:12px;
              align-items:center;
              flex-wrap:wrap;
            }
            #canvasApp .c-grow{flex:1; min-width: 240px;}

            #canvasApp .c-btn-primary{
              border:0;
              background: var(--ic-gold);
              color: #1f2937;
              font-weight:1000;
              border-radius:14px;
              padding:12px 16px;
              cursor:pointer;
              white-space:nowrap;
            }

            #canvasApp .c-alert{
              margin-top:12px;
              border-radius:14px;
              padding:12px 14px;
              border:1px solid transparent;
              display:flex;
              gap:10px;
              align-items:flex-start;
              font-size:14px;
            }
            #canvasApp .c-alert.ok{background:#ecfdf5;border-color:#bbf7d0;color:#166534;}
            #canvasApp .c-alert.bad{background:#fef2f2;border-color:#fecaca;color:#991b1b;}
            #canvasApp .c-alert.neutral{background:#f8fafc;border-color:#e2e8f0;color:#334155;}
            #canvasApp .c-alert small{display:block;opacity:.9}

            #canvasApp .c-foot{
              color:var(--muted);
              font-size:12px;
              margin-top:10px;
              line-height:1.4;
            }
            #canvasApp code.k{
              background:#f1f5f9;border:1px solid #e2e8f0;
              padding:2px 8px;border-radius:999px;
              font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
              font-size:12px;
            }

            #canvasApp .c-user-top{
              display:flex;
              align-items:center;
              justify-content:space-between;
              gap:12px;
              padding:8px 0 6px;
              border-bottom:1px solid var(--line);
              margin-bottom:12px;
              flex-wrap:wrap;
            }
            #canvasApp .c-user-name{
              font-weight:1000;
              letter-spacing:.4px;
              margin:0;
              font-size:16px;
              text-transform:uppercase;
            }
            #canvasApp .c-user-meta{
              margin:6px 0 0;
              color:var(--muted);
              font-size:13px;
              line-height:1.4;
            }

            #canvasApp .c-pill{
              display:inline-flex;align-items:center;gap:8px;
              border-radius:999px;padding:8px 12px;
              border:1px solid var(--line);background:#fff;
              font-weight:1000;color:#111827;white-space:nowrap;
            }
            #canvasApp .c-pill.ok{border-color:#bbf7d0;background:#ecfdf5;}
            #canvasApp .c-pill.bad{border-color:#fecaca;background:#fef2f2;}
            #canvasApp .c-pill .dot{
              width:10px;height:10px;border-radius:50%;
              background:var(--warn);
            }
            #canvasApp .c-pill .dot.ok{background:var(--ok)}
            #canvasApp .c-pill .dot.bad{background:var(--bad)}

            #canvasApp .c-actions-user{
              display:flex;
              gap:10px;
              margin-top:14px;
              flex-wrap:wrap;
            }
            #canvasApp .c-btn-danger,
            #canvasApp .c-btn-success{
              border-radius:14px;
              padding:12px 14px;
              font-weight:1000;
              border:1px solid transparent;
              cursor:pointer;
              min-width:140px;
            }
            #canvasApp .c-btn-danger{background:#fef2f2;border-color:#fecaca;color:#991b1b;}
            #canvasApp .c-btn-success{background:#ecfdf5;border-color:#bbf7d0;color:#166534;}
            #canvasApp .c-btn-disabled{opacity:.55;cursor:not-allowed;}

            #canvasApp .c-table-card{
              padding:16px;
              border-top:1px solid var(--line);
            }
            #canvasApp .c-table-head h4{
              margin:0;
              font-size:16px;
              font-weight:1000;
            }
            #canvasApp .c-table-head p{
              margin:6px 0 0;
              color:var(--muted);
              font-size:13px;
            }

            #canvasApp table{
              width:100%;
              border-collapse:separate;
              border-spacing:0;
              border:1px solid var(--line);
              border-radius:14px;
              background:#fff;
              overflow:hidden;
              margin-top:12px;
            }
            #canvasApp thead th{
              text-align:left;
              font-size:13px;
              color:#334155;
              background:#f8fafc;
              border-bottom:1px solid var(--line);
              padding:12px 14px;
              font-weight:1000;
            }
            #canvasApp tbody td{
              padding:10px 14px;
              border-bottom:1px solid #eef2f7;
              vertical-align:middle;
              font-size:14px;
            }
            #canvasApp tbody tr:last-child td{border-bottom:0}
            #canvasApp .td-muted{color:var(--muted)}

            #canvasApp .c-btn-mini{
              border-radius:12px;
              padding:8px 12px;
              border:1px solid #fecaca;
              background:#fef2f2;
              color:#991b1b;
              font-weight:1000;
              cursor:pointer;
              white-space:nowrap;
            }
          </style>

          <section class="c-card">
            <div class="c-card-head">
              <h3>Operaciones de cuenta</h3>
              <p>Conectado al proxy de TI.</p>
            </div>

            <!-- ✅ AQUÍ ESTÁ el buscador y el panel usuario (lo que no te salía) -->
            <div class="c-grid">
              <!-- Buscar -->
              <div class="c-panel">
                <h4>Buscar usuario</h4>
                <p>Ingresa el SIS ID y la página mostrará el estado del usuario y sus matrículas activas.</p>

                <label class="c-label" for="sisId">SIS ID del usuario</label>
                <div class="c-row">
                  <div class="c-grow">
                    <input id="sisId" class="c-input" placeholder="Ej. 22500042" inputmode="numeric" />
                  </div>
                  <button class="c-btn-primary" id="btnBuscar" type="button">Buscar</button>
                </div>

                <div id="msgBuscar" class="c-alert neutral" style="display:none;"></div>

                <div class="c-foot">
                  Backend: <code class="k" id="backendHost">—</code><br/>
                  Tip: si algo no carga, prueba <code class="k">Ctrl</code> + <code class="k">F5</code>.
                </div>
              </div>

              <!-- Usuario -->
              <div class="c-panel">
                <h4>Usuario</h4>
                <p>Estado y acciones disponibles para el usuario encontrado.</p>

                <div class="c-user-top">
                  <div>
                    <p class="c-user-name" id="userName">Aún no se ha buscado ningún usuario.</p>
                    <div class="c-user-meta" id="userMeta"></div>
                  </div>

                  <div class="c-pill" id="pillEstadoUsuario" style="display:none;">
                    <span class="dot" id="dotEstadoUsuario"></span>
                    <span id="txtEstadoUsuario">—</span>
                  </div>
                </div>

                <div class="c-actions-user">
                  <button class="c-btn-danger c-btn-disabled" id="btnBaja" type="button" disabled>Dar de baja</button>
                  <button class="c-btn-success c-btn-disabled" id="btnReactivar" type="button" disabled>Reactivar</button>
                </div>

                <div class="c-foot" style="margin-top:12px;">
                  “Dar de baja” suspende logins, aplica prefijo y cierra sesiones. “Reactivar” revierte.
                </div>
              </div>
            </div>

            <!-- Tabla -->
            <div class="c-table-card">
              <div class="c-table-head">
                <h4>Matrículas activas</h4>
                <p>Cursos con opción de eliminar matrícula (task=delete).</p>
              </div>

              <table>
                <thead>
                  <tr>
                    <th style="width:60%;">Curso</th>
                    <th style="width:25%;">Código</th>
                    <th style="width:10%;">Enrollment</th>
                    <th style="width:5%;">Acción</th>
                  </tr>
                </thead>
                <tbody id="tbodyMatriculas">
                  <tr><td class="td-muted" colspan="4">Sin datos aún.</td></tr>
                </tbody>
              </table>

              <div id="msgAccion" class="c-alert neutral" style="display:none; margin-top:12px;"></div>
            </div>
          </section>

          <script>
            // ==========================
            // Canvas App JS (igual lógica)
            // ==========================
            const BACKEND_BASE = "https://ic-canvas-api.qualitydt.workers.dev";
            document.getElementById("backendHost").textContent = new URL(BACKEND_BASE).host;

            let usuarioActual = null;
            let enrollmentsActual = [];
            let loginsActual = [];
            const cacheCursos = new Map(); // course_id -> {name, course_code}

            function show(el){ el.style.display = ""; }
            function hide(el){ el.style.display = "none"; }

            function setAlert(el, tipo, html){
              el.className = "c-alert " + tipo;
              el.innerHTML = html;
              show(el);
            }

            function setBackendStatus(ok, text){
              const dot = document.getElementById("dotBackend");
              const txt = document.getElementById("txtBackend");
              dot.classList.remove("ok","bad");
              txt.textContent = text;
              if (ok === true) dot.classList.add("ok");
              if (ok === false) dot.classList.add("bad");
            }

            function setUsuarioEstado(estaBaja){
              const pill = document.getElementById("pillEstadoUsuario");
              const dot = document.getElementById("dotEstadoUsuario");
              const txt = document.getElementById("txtEstadoUsuario");

              dot.classList.remove("ok","bad");
              pill.classList.remove("ok","bad");

              if (estaBaja){
                dot.classList.add("bad");
                pill.classList.add("bad");
                txt.textContent = "De baja";
              } else {
                dot.classList.add("ok");
                pill.classList.add("ok");
                txt.textContent = "Activo";
              }
              show(pill);
            }

            function enableActions(enableBaja, enableReactivar){
              const btnBaja = document.getElementById("btnBaja");
              const btnReactivar = document.getElementById("btnReactivar");

              btnBaja.disabled = !enableBaja;
              btnReactivar.disabled = !enableReactivar;

              btnBaja.classList.toggle("c-btn-disabled", !enableBaja);
              btnReactivar.classList.toggle("c-btn-disabled", !enableReactivar);
            }

            async function httpJson(url, options = {}){
              const res = await fetch(url, {
                ...options,
                headers: { "Content-Type":"application/json", ...(options.headers || {}) }
              });
              const text = await res.text();
              let data = null;
              try { data = text ? JSON.parse(text) : null; } catch { data = text; }
              if (!res.ok){
                const msg = (data && data.error) ? data.error : "Error";
                throw new Error(msg + (data && data.status ? ` (${data.status})` : ""));
              }
              return data;
            }

            async function healthcheck(){
              try{ await httpJson(`${BACKEND_BASE}/`); setBackendStatus(true,"Conectado"); }
              catch{ setBackendStatus(false,"Sin conexión"); }
            }

            async function buscarUsuarioPorSisId(sis){
              return await httpJson(`${BACKEND_BASE}/user?sis=${encodeURIComponent(sis)}`);
            }

            async function obtenerLogins(user_id){
              return await httpJson(`${BACKEND_BASE}/logins?user_id=${encodeURIComponent(user_id)}`);
            }

            async function obtenerEnrollments(user_id){
              return await httpJson(`${BACKEND_BASE}/enrollments?user_id=${encodeURIComponent(user_id)}`);
            }

            async function obtenerCurso(course_id){
              if (cacheCursos.has(course_id)) return cacheCursos.get(course_id);
              const data = await httpJson(`${BACKEND_BASE}/course?course_id=${encodeURIComponent(course_id)}`);
              const info = {
                name: data?.name || `Curso ${course_id}`,
                course_code: data?.course_code || ""
              };
              cacheCursos.set(course_id, info);
              return info;
            }

            function usuarioEstaDadoDeBaja(user, logins){
              const PREFIJO = "D1sVb13d_";
              const email = (user?.email || "");
              if (email.startsWith(PREFIJO)) return true;
              for (const l of (logins || [])){
                if (l?.workflow_state === "suspended") return true;
                const loginId = (l?.login_id || "");
                if (loginId.startsWith(PREFIJO)) return true;
              }
              return false;
            }

            async function darDeBaja(user){
              return await httpJson(`${BACKEND_BASE}/baja`, {
                method:"POST",
                body: JSON.stringify({ user_id: user.id, email: user.email || "" })
              });
            }

            async function reactivar(user){
              return await httpJson(`${BACKEND_BASE}/reactivar`, {
                method:"POST",
                body: JSON.stringify({ user_id: user.id, email: user.email || "" })
              });
            }

            async function eliminarMatricula(course_id, enrollment_id){
              return await httpJson(`${BACKEND_BASE}/delete-enrollment`, {
                method:"POST",
                body: JSON.stringify({ course_id, enrollment_id })
              });
            }

            function escapeHtml(str){
              return String(str)
                .replaceAll("&","&amp;")
                .replaceAll("<","&lt;")
                .replaceAll(">","&gt;")
                .replaceAll('"',"&quot;")
                .replaceAll("'","&#039;");
            }

            function codigoCortoDesdeTexto(texto){
              if (!texto) return "";
              const m = String(texto).match(/(?:^|[-\s])(\d{4})-S(\d{2})-(\d{4})(?:$|[\s])/i);
              if (m) return `${m[1]}S${m[2]}${m[3]}`;
              const m2 = String(texto).match(/(\d{4})\s*-\s*S(\d{2})\s*-\s*(\d{4})/i);
              if (m2) return `${m2[1]}S${m2[2]}${m2[3]}`;
              return "";
            }

            function obtenerCodigoCorto(nombreCurso, courseCode){
              let corto = codigoCortoDesdeTexto(courseCode);
              if (corto) return corto;
              corto = codigoCortoDesdeTexto(nombreCurso);
              if (corto) return corto;
              return (courseCode && String(courseCode).trim()) ? String(courseCode).trim() : "—";
            }

            function renderUsuario(user, logins){
              const nameEl = document.getElementById("userName");
              const metaEl = document.getElementById("userMeta");

              if (!user){
                nameEl.textContent = "Aún no se ha buscado ningún usuario.";
                metaEl.innerHTML = "";
                hide(document.getElementById("pillEstadoUsuario"));
                enableActions(false,false);
                return;
              }

              nameEl.textContent = (user.name || "Sin nombre").toUpperCase();
              metaEl.innerHTML = `
                <div>Canvas ID: <b>${user.id}</b></div>
                <div>Email: <b>${escapeHtml(user.email || "—")}</b></div>
              `;

              const baja = usuarioEstaDadoDeBaja(user, logins);
              setUsuarioEstado(baja);
              enableActions(!baja, baja);
            }

            async function enriquecerCursos(enrollments){
              const unicos = new Set();
              for (const e of enrollments || []) {
                if (!e.course || !e.course.name) unicos.add(e.course_id);
                else {
                  cacheCursos.set(e.course_id, {
                    name: e.course.name || `Curso ${e.course_id}`,
                    course_code: e.course.course_code || ""
                  });
                }
              }
              const ids = Array.from(unicos).filter(Boolean);
              await Promise.all(ids.map(async (cid) => {
                try { await obtenerCurso(cid); } catch(_) {}
              }));
            }

            function renderMatriculas(enrollments){
              const tb = document.getElementById("tbodyMatriculas");
              tb.innerHTML = "";

              if (!enrollments || enrollments.length === 0){
                tb.innerHTML = `<tr><td class="td-muted" colspan="4">No tiene matrículas activas.</td></tr>`;
                return;
              }

              const sorted = [...enrollments].sort((a,b)=>{
                const na = (cacheCursos.get(a.course_id)?.name || a.course?.name || `Curso ${a.course_id}`).toLowerCase();
                const nb = (cacheCursos.get(b.course_id)?.name || b.course?.name || `Curso ${b.course_id}`).toLowerCase();
                return na.localeCompare(nb);
              });

              for (const e of sorted){
                const courseId = e.course_id;
                const enrollmentId = e.id || "—";

                const infoCache = cacheCursos.get(courseId) || {};
                const nombre = e.course?.name || infoCache.name || `Curso ${courseId}`;
                const codigoRaw = e.course?.course_code || infoCache.course_code || "";
                const codigo = obtenerCodigoCorto(nombre, codigoRaw);

                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td>${escapeHtml(nombre)}</td>
                  <td class="td-muted">${escapeHtml(codigo || "—")}</td>
                  <td>${escapeHtml(String(enrollmentId))}</td>
                  <td>
                    <button class="c-btn-mini" data-course="${courseId}" data-enr="${enrollmentId}">Eliminar</button>
                  </td>
                `;
                tb.appendChild(tr);
              }

              tb.querySelectorAll("button.c-btn-mini").forEach(btn=>{
                btn.addEventListener("click", async ()=>{
                  const course_id = btn.getAttribute("data-course");
                  const enrollment_id = btn.getAttribute("data-enr");
                  if (!usuarioActual) return;

                  const ok = confirm("¿Seguro que deseas eliminar esta matrícula? (task=delete)");
                  if (!ok) return;

                  const msgAccion = document.getElementById("msgAccion");
                  try{
                    setAlert(msgAccion, "neutral", "Eliminando matrícula...");
                    await eliminarMatricula(course_id, enrollment_id);
                    setAlert(msgAccion, "ok", "Matrícula eliminada ✅");

                    enrollmentsActual = await obtenerEnrollments(usuarioActual.id);
                    await enriquecerCursos(enrollmentsActual);
                    renderMatriculas(enrollmentsActual);
                  }catch(e){
                    setAlert(msgAccion, "bad", `No se pudo eliminar. <small>${escapeHtml(e.message)}</small>`);
                  }
                });
              });
            }

            document.getElementById("btnBuscar").addEventListener("click", buscar);
            document.getElementById("sisId").addEventListener("keydown", (e)=>{ if (e.key === "Enter") buscar(); });

            document.getElementById("btnBaja").addEventListener("click", async ()=>{
              if (!usuarioActual) return;
              if (!confirm("¿Dar de baja al usuario? (prefijo + suspended + cerrar sesiones)")) return;

              const msgAccion = document.getElementById("msgAccion");
              try{
                setAlert(msgAccion, "neutral", "Dando de baja al usuario...");
                await darDeBaja(usuarioActual);
                setAlert(msgAccion, "ok", "Usuario dado de baja ✅");

                loginsActual = await obtenerLogins(usuarioActual.id);
                usuarioActual = await buscarUsuarioPorSisId(usuarioActual.sis_user_id);
                renderUsuario(usuarioActual, loginsActual);
              }catch(e){
                setAlert(msgAccion, "bad", `No se pudo dar de baja. <small>${escapeHtml(e.message)}</small>`);
              }
            });

            document.getElementById("btnReactivar").addEventListener("click", async ()=>{
              if (!usuarioActual) return;
              if (!confirm("¿Reactivar al usuario? (quitar prefijo + active)")) return;

              const msgAccion = document.getElementById("msgAccion");
              try{
                setAlert(msgAccion, "neutral", "Reactivando usuario...");
                await reactivar(usuarioActual);
                setAlert(msgAccion, "ok", "Usuario reactivado ✅");

                loginsActual = await obtenerLogins(usuarioActual.id);
                usuarioActual = await buscarUsuarioPorSisId(usuarioActual.sis_user_id);
                renderUsuario(usuarioActual, loginsActual);
              }catch(e){
                setAlert(msgAccion, "bad", `No se pudo reactivar. <small>${escapeHtml(e.message)}</small>`);
              }
            });

            async function buscar(){
              const sis = document.getElementById("sisId").value.trim();
              const msgBuscar = document.getElementById("msgBuscar");
              const msgAccion = document.getElementById("msgAccion");
              hide(msgAccion);

              if (!sis){
                setAlert(msgBuscar, "bad", "Ingresa un SIS ID válido.");
                return;
              }

              setAlert(msgBuscar, "neutral", "Buscando usuario...");

              try{
                usuarioActual = await buscarUsuarioPorSisId(sis);
                loginsActual = await obtenerLogins(usuarioActual.id);
                enrollmentsActual = await obtenerEnrollments(usuarioActual.id);

                await enriquecerCursos(enrollmentsActual);

                setAlert(msgBuscar, "ok", "Usuario encontrado ✅");
                renderUsuario(usuarioActual, loginsActual);
                renderMatriculas(enrollmentsActual);
              }catch(e){
                usuarioActual = null; loginsActual = []; enrollmentsActual = [];
                renderUsuario(null, []);
                renderMatriculas([]);
                setAlert(msgBuscar, "bad", `No se pudo buscar el usuario. <small>${escapeHtml(e.message)}</small>`);
              }
            }

            enableActions(false,false);
            healthcheck();
          </script>

        </div>
      </div>
    </section>

    <!-- ===== Panel M365 ===== -->
    <section class="panel" id="panel-m365">
      <div class="panelHead">
        <div>
          <h2>M365 • Reportes (Teams / OneDrive)</h2>
          <p>Sube el CSV exportado, se filtrará por usuarios activos y se descargará un Excel listo para uso.</p>
        </div>
        <button class="btn ghost" data-close>Volver</button>
      </div>

      <div class="panelBody">
        <div class="row">
          <div class="card">
            <h3>Usuarios activos (lista central)</h3>
            <p class="muted">Lista administrada por TI. Para actualizar usuarios, modificar el archivo data/usuarios_m365.txt en el repositorio.</p>
            <div class="line"></div>
            <textarea id="m365-usuarios" readonly></textarea>
          </div>

          <div class="card">
            <h3>Archivos de entrada</h3>
            <p class="muted">Sube el CSV correspondiente y descarga el Excel generado.</p>

            <div class="line"></div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <label class="btn primary" for="m365-teams">Subir CSV Teams</label>
              <input id="m365-teams" type="file" accept=".csv,text/csv" />
              <button class="btn" id="m365-procesar-teams" disabled>Generar Teams.xlsx</button>
            </div>

            <div class="kv">
              <div class="k">Teams</div><div class="v" id="m365-teams-nombre">—</div>
            </div>

            <div class="line"></div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <label class="btn primary" for="m365-onedrive">Subir CSV OneDrive</label>
              <input id="m365-onedrive" type="file" accept=".csv,text/csv" />
              <button class="btn" id="m365-procesar-onedrive" disabled>Generar OneDrive.xlsx</button>
            </div>

            <div class="kv">
              <div class="k">OneDrive</div><div class="v" id="m365-onedrive-nombre">—</div>
            </div>

            <div class="progress" id="m365-progress"><div class="bar" id="m365-bar"></div></div>
            <div class="toast" id="m365-toast"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== Panel Otros (EDDI) ===== -->
    <section class="panel" id="panel-otros">
      <div class="panelHead">
        <div>
          <h2>Otros • EDDI</h2>
          <p>Sube el Excel, elige la hoja (si quieres) y descarga <b>EDDI_procesado.xlsx</b>.</p>
        </div>
        <button class="btn ghost" data-close>Volver</button>
      </div>

      <div class="panelBody">
        <div class="row">
          <div class="card">
            <h3>Archivo de entrada</h3>
            <p class="muted">No dependemos del nombre de la hoja. Se usa la primera por defecto.</p>
            <div class="line"></div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <label class="btn primary" for="eddi-archivo">Subir Excel EDDI</label>
              <input id="eddi-archivo" type="file" accept=".xlsx,.xls" />
              <button class="btn" id="eddi-procesar" disabled>Generar EDDI_procesado.xlsx</button>
            </div>

            <div class="kv">
              <div class="k">Archivo</div><div class="v" id="eddi-nombre">—</div>
            </div>

            <div class="line"></div>

            <div>
              <label style="font-weight:900;font-size:12.5px">Hoja a usar</label>
              <select id="eddi-hoja" disabled></select>
              <div class="hint">Si no cambias nada, se usará la primera hoja.</div>
            </div>

            <div class="progress" id="eddi-progress"><div class="bar" id="eddi-bar"></div></div>
            <div class="toast" id="eddi-toast"></div>
          </div>

          <div class="card">
            <h3>Qué genera</h3>
            <p class="muted">
              - Hoja <b>Datos</b>: contenido original (de la hoja seleccionada).<br>
              - Hoja <b>Datos procesados</b>: promedio anual y frecuencia por docente.
            </p>
            <div class="line"></div>
            <p class="muted">
              Columnas esperadas (mínimo): <b>ID Docente</b>, <b>Nombre</b>, <b>Desempeño Pedagógico</b>, <b>Desempeño Administrativo</b>.
              Si cambian ligeramente los nombres, lo intentamos reconocer.
            </p>
          </div>
        </div>
      </div>
    </section>

  </div>
</main>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // =========================
  // Navegación simple (tiles)
  // =========================
  const panels = [...document.querySelectorAll(".panel")];
  const tiles = [...document.querySelectorAll(".tile")];

  tiles.forEach(t => {
    t.addEventListener("click", () => {
      const id = t.getAttribute("data-open");
      panels.forEach(p => p.classList.remove("show"));
      document.getElementById(id)?.classList.add("show");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  });

  document.querySelectorAll("[data-close]").forEach(b=>{
    b.addEventListener("click", ()=>{
      panels.forEach(p => p.classList.remove("show"));
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  });

  // Si faltan imágenes, mostrar placeholders
  window.addEventListener("load", ()=>{
    [["assets/canvas.png","ph-canvas"],["assets/m365.png","ph-m365"],["assets/otros.png","ph-otros"]]
      .forEach(([src, phId], idx)=>{
        const img = document.querySelectorAll(".tileTop img")[idx];
        if (img && img.style.display === "none") document.getElementById(phId).style.display = "block";
      });
  });

  // =========================================
  // Helpers UI
  // =========================================
  function setToast(el, type, msg){
    el.className = "toast " + (type || "");
    el.textContent = msg;
    el.style.display = "block";
  }
  function clearToast(el){
    el.style.display = "none";
    el.textContent = "";
    el.className = "toast";
  }
  function setProgress(prog, bar, pct){
    prog.style.display = "block";
    bar.style.width = pct + "%";
  }
  function hideProgress(prog, bar){
    prog.style.display = "none";
    bar.style.width = "0%";
  }
  function descargarBlob(blob, nombre){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = nombre;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  function fechaDDMM(){
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    return dd + mm;
  }
  function normalizar(s){
    return String(s||"").trim().toLowerCase().replace(/\s+/g,"");
  }

  // =========================================
  // M365 - Usuarios activos (desde TXT del repo)
  // =========================================
  const txtUsuarios = document.getElementById("m365-usuarios");
  const URL_USUARIOS_REPO = "data/usuarios_m365.txt";

  async function cargarUsuariosDesdeRepo(){
    // Mensaje visible mientras carga
    txtUsuarios.value = "Cargando lista de usuarios…";

    try{
      // Cache bust para evitar versiones viejas
      const url = URL_USUARIOS_REPO + "?v=" + Date.now();

      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error("HTTP " + resp.status);

      // Ojo BOM (a veces el txt viene con BOM invisible)
      let texto = await resp.text();
      texto = texto.replace(/^\uFEFF/, "").trim();

      if (!texto) throw new Error("TXT vacío");

      txtUsuarios.value = texto;

    }catch (e){
      console.warn("No se pudo cargar usuarios desde TXT:", e);

      // Fallback SIEMPRE a default embebido (para que no quede vacío)
      if (typeof usuariosDefault !== "undefined" && usuariosDefault.length){
        txtUsuarios.value = usuariosDefault.join("\n");
      } else {
        txtUsuarios.value = "No se pudo cargar la lista.\nVerifica data/usuarios_m365.txt";
      }
    }
  }

  function obtenerSetUsuarios(){
    return new Set(
      txtUsuarios.value
        .split(/\r?\n/)
        .map(x => x.trim().toLowerCase())
        .filter(Boolean)
    );
  }

  // Cargar al iniciar
  cargarUsuariosDesdeRepo();

  // =========================================
  // M365 - Teams / OneDrive
  // =========================================
  const inputTeams = document.getElementById("m365-teams");
  const inputOne   = document.getElementById("m365-onedrive");
  const nombreTeams= document.getElementById("m365-teams-nombre");
  const nombreOne  = document.getElementById("m365-onedrive-nombre");
  const btnTeams   = document.getElementById("m365-procesar-teams");
  const btnOne     = document.getElementById("m365-procesar-onedrive");
  const m365Toast  = document.getElementById("m365-toast");
  const m365Prog   = document.getElementById("m365-progress");
  const m365Bar    = document.getElementById("m365-bar");

  let archivoTeams = null;
  let archivoOne   = null;

  inputTeams.addEventListener("change", ()=>{
    archivoTeams = inputTeams.files?.[0] || null;
    nombreTeams.textContent = archivoTeams ? archivoTeams.name : "—";
    btnTeams.disabled = !archivoTeams;
  });

  inputOne.addEventListener("change", ()=>{
    archivoOne = inputOne.files?.[0] || null;
    nombreOne.textContent = archivoOne ? archivoOne.name : "—";
    btnOne.disabled = !archivoOne;
  });

  function leerCSV(file){
    return new Promise((resolve, reject)=>{
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (res)=> resolve(res),
        error: (err)=> reject(err)
      });
    });
  }

  // Teams: seleccionamos columnas por nombre (más robusto que índices)
  const columnasTeamsSalida = [
    "Report Refresh Date",
    "User Principal Name",
    "Last Activity Date",
    "Team Chat Message Count",
    "Private Chat Message Count",
    "Call Count",
    "Meeting Count",
    "Meetings Organized Count",
    "Meetings Attended Count",
    "Ad Hoc Meetings Organized Count",
    "Ad Hoc Meetings Attended Count",
    "Scheduled One-time Meetings Organized Count",
    "Scheduled One-time Meetings Attended Count",
    "Scheduled Recurring Meetings Organized Count",
    "Scheduled Recurring Meetings Attended Count",
    "Audio Duration",
    "Video Duration",
    "Screen Share Duration",
    "Audio Duration In Seconds",
    "Video Duration In Seconds",
    "Screen Share Duration In Seconds",
    "Has Other Action",
    "Urgent Messages",
    "Post Messages",
    "Reply Messages"
  ];

  // OneDrive
  const columnasOneSalida = [
    "Report Refresh Date",
    "Owner Display Name",
    "Last Activity Date",
    "File Count",
    "Active File Count",
    "Storage Used (Byte)",
    "Owner Principal Name",
    "Report Period"
  ];

  function getValor(row, colName){
    // intenta exacto, y si no, intenta match por normalización (por si cambia un poco)
    if (row[colName] !== undefined) return row[colName];
    const objetivo = normalizar(colName);
    const key = Object.keys(row).find(k => normalizar(k) === objetivo);
    return key ? row[key] : "";
  }

  btnTeams.addEventListener("click", async ()=>{
    if (!archivoTeams) return;

    clearToast(m365Toast);
    setToast(m365Toast, "warn", "Procesando Teams…");
    setProgress(m365Prog, m365Bar, 20);

    try{
      const usuariosSet = obtenerSetUsuarios();
      if (usuariosSet.size === 0){
        hideProgress(m365Prog, m365Bar);
        setToast(m365Toast, "bad", "La lista de usuarios está vacía.");
        return;
      }

      const res = await leerCSV(archivoTeams);
      setProgress(m365Prog, m365Bar, 55);

      // Detectar columna donde viene el correo (UPN)
      // En el export suele ser "User Principal Name"
      const rows = res.data || [];
      const filtrados = rows.filter(r=>{
        const upn = String(getValor(r, "User Principal Name") || "").trim().toLowerCase();
        return usuariosSet.has(upn);
      });

      // Crear Excel
      const wb = new ExcelJS.Workbook();
      const ws = wb.addWorksheet("Teams", { views: [{ state:"frozen", ySplit: 1 }] });

      ws.addRow(columnasTeamsSalida);
      ws.getRow(1).eachCell(c=>{
        c.fill = { type:"pattern", pattern:"solid", fgColor:{ argb:"FF4B2E83" } };
        c.font = { bold:true, color:{ argb:"FFFFFFFF" } };
        c.alignment = { vertical:"middle", horizontal:"left" };
      });

      for (let i=0;i<filtrados.length;i++){
        const r = filtrados[i];
        ws.addRow(columnasTeamsSalida.map(col => String(getValor(r, col) ?? "")));
      }

      // AutoFilter
      ws.autoFilter = { from:{row:1,column:1}, to:{row:1,column:columnasTeamsSalida.length} };

      setProgress(m365Prog, m365Bar, 80);

      const buffer = await wb.xlsx.writeBuffer();
      const nombre = `Teams7${fechaDDMM()}.xlsx`;
      descargarBlob(new Blob([buffer], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}), nombre);

      setProgress(m365Prog, m365Bar, 100);
      setToast(m365Toast, "ok", `Listo ✅ Se generó ${nombre}`);
      setTimeout(()=>{ hideProgress(m365Prog, m365Bar); }, 900);

    }catch(e){
      console.error(e);
      hideProgress(m365Prog, m365Bar);
      setToast(m365Toast, "bad", "No se pudo procesar el archivo de Teams.");
    }
  });

  btnOne.addEventListener("click", async ()=>{
    if (!archivoOne) return;

    clearToast(m365Toast);
    setToast(m365Toast, "warn", "Procesando OneDrive…");
    setProgress(m365Prog, m365Bar, 20);

    try{
      const usuariosSet = obtenerSetUsuarios();
      if (usuariosSet.size === 0){
        hideProgress(m365Prog, m365Bar);
        setToast(m365Toast, "bad", "La lista de usuarios está vacía.");
        return;
      }

      const res = await leerCSV(archivoOne);
      setProgress(m365Prog, m365Bar, 55);

      const rows = res.data || [];
      // En export suele ser "Owner Principal Name"
      const filtrados = rows.filter(r=>{
        const upn = String(getValor(r, "Owner Principal Name") || "").trim().toLowerCase();
        return usuariosSet.has(upn);
      });

      const wb = new ExcelJS.Workbook();
      const ws = wb.addWorksheet("OneDrive", { views: [{ state:"frozen", ySplit: 1 }] });

      ws.addRow(columnasOneSalida);
      ws.getRow(1).eachCell(c=>{
        c.fill = { type:"pattern", pattern:"solid", fgColor:{ argb:"FF4B2E83" } };
        c.font = { bold:true, color:{ argb:"FFFFFFFF" } };
        c.alignment = { vertical:"middle", horizontal:"left" };
      });

      for (let i=0;i<filtrados.length;i++){
        const r = filtrados[i];
        ws.addRow(columnasOneSalida.map(col => String(getValor(r, col) ?? "")));
      }

      ws.autoFilter = { from:{row:1,column:1}, to:{row:1,column:columnasOneSalida.length} };

      setProgress(m365Prog, m365Bar, 80);

      const buffer = await wb.xlsx.writeBuffer();
      const nombre = `OneDrive7${fechaDDMM()}.xlsx`;
      descargarBlob(new Blob([buffer], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}), nombre);

      setProgress(m365Prog, m365Bar, 100);
      setToast(m365Toast, "ok", `Listo ✅ Se generó ${nombre}`);
      setTimeout(()=>{ hideProgress(m365Prog, m365Bar); }, 900);

    }catch(e){
      console.error(e);
      hideProgress(m365Prog, m365Bar);
      setToast(m365Toast, "bad", "No se pudo procesar el archivo de OneDrive.");
    }
  });

  // =========================================
  // EDDI
  // - Lee xlsx con SheetJS (xlsx)
  // - Procesa y exporta con ExcelJS (para poder darle estilo simple si quieres)
  // =========================================
  const inputEddi = document.getElementById("eddi-archivo");
  const eddiNombre= document.getElementById("eddi-nombre");
  const eddiSelect= document.getElementById("eddi-hoja");
  const eddiBtn   = document.getElementById("eddi-procesar");
  const eddiToast = document.getElementById("eddi-toast");
  const eddiProg  = document.getElementById("eddi-progress");
  const eddiBar   = document.getElementById("eddi-bar");

  let eddiLibro = null;

  inputEddi.addEventListener("change", async ()=>{
    const file = inputEddi.files?.[0] || null;
    if (!file){
      eddiNombre.textContent = "—";
      eddiSelect.disabled = true;
      eddiBtn.disabled = true;
      return;
    }

    eddiNombre.textContent = file.name;
    clearToast(eddiToast);
    setToast(eddiToast, "warn", "Leyendo Excel…");
    setProgress(eddiProg, eddiBar, 25);

    try{
      const ab = await file.arrayBuffer();
      eddiLibro = XLSX.read(ab, { type: "array" });

      // poblar selector de hojas
      eddiSelect.innerHTML = "";
      eddiLibro.SheetNames.forEach((name, idx)=>{
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name + (idx===0 ? " (primera)" : "");
        eddiSelect.appendChild(opt);
      });

      eddiSelect.disabled = false;
      eddiBtn.disabled = false;

      setProgress(eddiProg, eddiBar, 100);
      setToast(eddiToast, "ok", "Listo ✅ Excel cargado");
      setTimeout(()=>{ hideProgress(eddiProg, eddiBar); }, 800);

    }catch(e){
      console.error(e);
      hideProgress(eddiProg, eddiBar);
      setToast(eddiToast, "bad", "No se pudo leer el Excel.");
      eddiLibro = null;
      eddiBtn.disabled = true;
      eddiSelect.disabled = true;
    }
  });

  function buscarColumna(cols, candidatos){
    // cols: array de nombres originales
    // candidatos: array de "nombres esperados" (variantes)
    const ncols = cols.map(c => normalizar(c));
    for (const cand of candidatos){
      const idx = ncols.indexOf(normalizar(cand));
      if (idx >= 0) return cols[idx];
    }
    // búsqueda por contains (por si le agregan algo)
    for (const cand of candidatos){
      const nc = normalizar(cand);
      const idx2 = ncols.findIndex(x => x.includes(nc) || nc.includes(x));
      if (idx2 >= 0) return cols[idx2];
    }
    return null;
  }

  function aNumero(v){
    if (v === null || v === undefined) return NaN;
    const s = String(v).replace(",", ".").trim();
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  eddiBtn.addEventListener("click", async ()=>{
    if (!eddiLibro) return;

    clearToast(eddiToast);
    setToast(eddiToast, "warn", "Procesando EDDI…");
    setProgress(eddiProg, eddiBar, 20);

    try{
      const hojaElegida = eddiSelect.value || eddiLibro.SheetNames[0];
      const ws = eddiLibro.Sheets[hojaElegida];

      // 1) Leer como array-of-arrays (más control para skiprows)
      const filas = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: true });

      // Validaciones
      if (!filas || filas.length < 2){
        hideProgress(eddiProg, eddiBar);
        setToast(eddiToast, "bad", "La hoja no tiene suficientes filas para procesar.");
        return;
      }

      // 2) Skip primera fila (como skiprows=1 en pandas)
      const filasSinPrimera = filas.slice(1);

      // 3) Encabezados reales (primera fila luego del skip)
      const encabezadosOriginales = (filasSinPrimera[0] || []).map(x => String(x || "").trim());
      const filasDatos = filasSinPrimera.slice(1);

      // Si por algún motivo los encabezados están vacíos
      if (!encabezadosOriginales.some(h => h)){
        hideProgress(eddiProg, eddiBar);
        setToast(eddiToast, "bad", "No se detectaron encabezados válidos (después de la primera fila).");
        return;
      }

      // 4) Construir JSON con esos encabezados
      const json = filasDatos
        .filter(row => row.some(v => String(v||"").trim() !== "")) // ignora filas vacías
        .map(row => {
          const obj = {};
          for (let i = 0; i < encabezadosOriginales.length; i++){
            const key = encabezadosOriginales[i] || `Columna_${i+1}`;
            obj[key] = (row[i] ?? "");
          }
          return obj;
        });

      // Columnas (headers)
      const columnas = encabezadosOriginales;

      const colId   = buscarColumna(columnas, ["ID Docente", "IDDocente", "Codigo", "Códigos"]);
      const colNom  = buscarColumna(columnas, ["Nombre", "Nombre Docente", "Docente"]);
      const colPed  = buscarColumna(columnas, ["Desempeño Pedagógico", "Desempeño Pedagogico"]);
      const colAdm  = buscarColumna(columnas, ["Desempeño Administrativo", "Desempeño Administrativo "]);

      if (!colId || !colNom || !colPed || !colAdm){
        hideProgress(eddiProg, eddiBar);
        setToast(eddiToast, "bad", "No se encontraron columnas clave (ID Docente, Nombre, Desempeño Pedagógico, Desempeño Administrativo).");
        return;
      }

      // Agrupar
      const mapa = new Map(); // key = ID|Nombre
      for (const r of json){
        const id = String(r[colId]).trim();
        const nombre = String(r[colNom]).trim();
        if (!id || !nombre) continue;

        const key = id + "||" + nombre;
        const ped = aNumero(r[colPed]);
        const adm = aNumero(r[colAdm]);

        if (!mapa.has(key)){
          mapa.set(key, { id, nombre, sumaPed:0, sumaAdm:0, cntPed:0, cntAdm:0, frec:0 });
        }
        const obj = mapa.get(key);
        obj.frec += 1;

        if (Number.isFinite(ped)){ obj.sumaPed += ped; obj.cntPed += 1; }
        if (Number.isFinite(adm)){ obj.sumaAdm += adm; obj.cntAdm += 1; }
      }

      const procesados = [];
      for (const obj of mapa.values()){
        const promPed = obj.cntPed ? (obj.sumaPed / obj.cntPed) : "";
        const promAdm = obj.cntAdm ? (obj.sumaAdm / obj.cntAdm) : "";
        procesados.push({
          "Códigos": obj.id,
          "Nombre": obj.nombre,
          "Desempeño anual pedagógico": promPed === "" ? "" : Number(promPed.toFixed(2)),
          "Desempeño anual administrativo": promAdm === "" ? "" : Number(promAdm.toFixed(2)),
          "Frecuencia": obj.frec
        });
      }

      // Exportar
      const wb = new ExcelJS.Workbook();

      const hojaDatos = wb.addWorksheet("Datos", { views: [{ state:"frozen", ySplit: 1 }] });
      const hojaProc  = wb.addWorksheet("Datos procesados", { views: [{ state:"frozen", ySplit: 1 }] });

      // Hoja Datos
      const colsDatos = columnas;
      hojaDatos.addRow(colsDatos);
      hojaDatos.getRow(1).eachCell(c=>{
        c.fill = { type:"pattern", pattern:"solid", fgColor:{ argb:"FF4B2E83" } };
        c.font = { bold:true, color:{ argb:"FFFFFFFF" } };
        c.alignment = { vertical:"middle", horizontal:"left" };
      });
      json.forEach(r=>{
        hojaDatos.addRow(colsDatos.map(c => r[c]));
      });

      setProgress(eddiProg, eddiBar, 70);

      // Hoja procesada
      const colsProc = ["Códigos","Nombre","Desempeño anual pedagógico","Desempeño anual administrativo","Frecuencia"];
      hojaProc.addRow(colsProc);
      hojaProc.getRow(1).eachCell(c=>{
        c.fill = { type:"pattern", pattern:"solid", fgColor:{ argb:"FF4B2E83" } };
        c.font = { bold:true, color:{ argb:"FFFFFFFF" } };
        c.alignment = { vertical:"middle", horizontal:"left" };
      });
      procesados.forEach(r=>{
        hojaProc.addRow(colsProc.map(c => r[c]));
      });

      hojaDatos.autoFilter = { from:{row:1,column:1}, to:{row:1,column:colsDatos.length} };
      hojaProc.autoFilter  = { from:{row:1,column:1}, to:{row:1,column:colsProc.length} };

      const buffer = await wb.xlsx.writeBuffer();
      descargarBlob(new Blob([buffer], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}), "EDDI_procesado.xlsx");

      setProgress(eddiProg, eddiBar, 100);
      setToast(eddiToast, "ok", "Listo ✅ Se generó EDDI_procesado.xlsx");
      setTimeout(()=>{ hideProgress(eddiProg, eddiBar); }, 900);

    }catch(e){
      console.error(e);
      hideProgress(eddiProg, eddiBar);
      setToast(eddiToast, "bad", "Ocurrió un error procesando EDDI.");
    }
  });
</script>
</body>
</html>
